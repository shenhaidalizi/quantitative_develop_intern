优化方向与主要类型
内存与带宽优化
仅按行计算差分与掩码，去掉全局中间矩阵。
预分配并复用所有临时数组；np.copyto 原地继承状态。
统一 float32，避免隐式 upcast 与不必要拷贝。
算子级优化
系统性使用 out=、原地 add/sub/mul/div/floor/max/min 组合，减少中间结果。
布尔索引更新改为掩码算术（连续内存、无散写）。
控制流优化
trade_mode 映射为整数一次性决策，消除循环内字符串比较。
早退出：has_buys/has_sells 判定减少不必要计算。
数据布局与缓存
np.ascontiguousarray 确保行视图连续；全程行向访问，缓存友好。
可能的进一步提升
用 Numba @njit(parallel=True, fastmath=True) 将列维并行（prange(n_weights)），通常 3-10x+。
超大规模时可分块处理权重维度，降低峰值内存与 L3 压力。
将固定参数提前矢量化常量（如 pct），减少每步标量转数组的广播成本。
结果：新版从根本上降低了“分配-拷贝-散写-类型升格”的代价，把瓶颈从 Python/内存搬到连续向量化算子上，因此显著更快。
