.PHONY: help build up down restart logs clean test status

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "è‚¡ç¥¨åˆ†æç›‘æ§ç³»ç»Ÿ - Monorepo"
	@echo "================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ========== Dockerç›¸å…³ ==========

build: ## æ„å»ºæ‰€æœ‰æœåŠ¡
	@echo "ğŸ”¨ æ„å»ºæ‰€æœ‰æœåŠ¡..."
	docker-compose build --parallel

up: ## å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…å«ç‹¬ç«‹Redisï¼‰
	@echo "ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
	docker-compose up -d 
	docker-compose up -d 
	@sleep 2
	@make status
	@echo ""
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨"
	@echo "ğŸ“Š Webç•Œé¢: http://localhost:8006"



# æ–‡ä»¶: Makefileï¼ˆæ ¹ç›®å½•ï¼‰å¯é€‰å¢åŠ ä¾¿æ·å‘½ä»¤
up-preprocess: ## å¯åŠ¨å®šæ—¶é¢„å¤„ç†
	@docker-compose up -d preprocess

logs-preprocess: ## æŸ¥çœ‹é¢„å¤„ç†æ—¥å¿—
	@docker-compose logs -f preprocess

# æ–‡ä»¶: Makefileï¼ˆæ ¹ç›®å½•ï¼‰å¯é€‰å¢åŠ ä¾¿æ·å‘½ä»¤
up-preprocess: ## å¯åŠ¨å®šæ—¶é¢„å¤„ç†
	@docker-compose up -d preprocess

logs-preprocess: ## æŸ¥çœ‹é¢„å¤„ç†æ—¥å¿—
	@docker-compose logs -f preprocess

down: ## åœæ­¢æ‰€æœ‰æœåŠ¡
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	docker-compose down



restart: ## é‡å¯æ‰€æœ‰æœåŠ¡
	@echo "ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡..."
	docker-compose restart
	@make status

# ========== æ—¥å¿—ç›¸å…³ ==========

logs: ## æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
	docker-compose logs -f

logs-analyzer: ## æŸ¥çœ‹Analyzeræ—¥å¿—
	docker-compose logs -f analyzer

logs-monitor: ## æŸ¥çœ‹Monitoræ—¥å¿—
	docker-compose logs -f monitor

logs-redis: ## æŸ¥çœ‹Redisæ—¥å¿—
	docker-compose logs -f redis

# ========== çŠ¶æ€å’Œè°ƒè¯• ==========

status: ## æŸ¥çœ‹æœåŠ¡çŠ¶æ€
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
	@docker-compose ps

ps: status ## åŒ status

shell-analyzer: ## è¿›å…¥Analyzerå®¹å™¨
	docker-compose exec analyzer /bin/bash

shell-monitor: ## è¿›å…¥Monitorå®¹å™¨
	docker-compose exec monitor /bin/sh

shell-redis: ## è¿›å…¥Rediså®¹å™¨
	docker-compose exec redis redis-cli

test-redis: ## æµ‹è¯•Redisè¿æ¥
	@echo "ğŸ” æµ‹è¯•Redisè¿æ¥..."
	@docker exec stock-monitor sh -c 'wget -q -O- http://localhost:8006/api/status | grep redis' || echo "âŒ è¿æ¥å¤±è´¥"

# ========== æµ‹è¯•ç›¸å…³ ==========

test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "ğŸ§ª è¿è¡ŒAnalyzeræµ‹è¯•..."
	cd services/analyzer && python -m pytest tests/ -v
	@echo ""
	@echo "ğŸ§ª è¿è¡ŒMonitoræµ‹è¯•..."
	cd services/monitor && npm test

test-analyzer: ## è¿è¡ŒAnalyzeræµ‹è¯•
	cd services/analyzer && python -m pytest tests/ -v

test-monitor: ## è¿è¡ŒMonitoræµ‹è¯•
	cd services/monitor && npm test

benchmark: ## è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
	cd services/analyzer && python benchmark_performance.py

# ========== æ¸…ç†ç›¸å…³ ==========

clean: ## æ¸…ç†å®¹å™¨å’Œæ•°æ®å·
	@echo "ğŸ§¹ æ¸…ç†å®¹å™¨å’Œæ•°æ®..."
	docker-compose down -v
	docker system prune -f

clean-data: ## æ¸…ç†æ•°æ®æ–‡ä»¶
	@echo "ğŸ—‘ï¸  æ¸…ç†æ•°æ®æ–‡ä»¶..."
	rm -rf services/analyzer/data/test_result/*
	rm -rf services/analyzer/data/index_data/*
	rm -rf services/analyzer/statistic_data/*.parquet
	@echo "âœ… æ•°æ®å·²æ¸…ç†"

clean-logs: ## æ¸…ç†æ—¥å¿—æ–‡ä»¶
	@echo "ğŸ—‘ï¸  æ¸…ç†æ—¥å¿—..."
	rm -rf shared/logs/*
	@echo "âœ… æ—¥å¿—å·²æ¸…ç†"

# ========== Gitç›¸å…³ ==========

git-status: ## æ£€æŸ¥GitçŠ¶æ€
	@echo "ğŸ“‹ GitçŠ¶æ€ï¼š"
	@git status -s

git-cleanup: ## æ¸…ç†å­ç›®å½•çš„Gitä»“åº“
	@bash cleanup_git.sh

# ========== å¼€å‘ç›¸å…³ ==========

prod: ## å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
	docker-compose up -d --build

install: ## å®‰è£…ä¾èµ–
	@echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–..."
	cd services/analyzer && pip install -r requirements.txt
	@echo "ğŸ“¦ å®‰è£…Node.jsä¾èµ–..."
	cd services/monitor && npm install

# ========== éƒ¨ç½²ç›¸å…³ ==========
