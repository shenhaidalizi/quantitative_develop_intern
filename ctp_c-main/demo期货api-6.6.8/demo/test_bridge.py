# /home/zhousiyuan/ctp_c/demo期货api-6.6.8/demo/test_bridge.py
import os, time, configparser, socket, re
from ctypes import cdll, c_char_p, c_double, c_int, PYFUNCTYPE, c_char, c_longlong
now_time = time.time()
base = os.path.dirname(__file__); os.chdir(base)
# flow 目录
os.environ.setdefault("CTP_FLOW_DIR_MD", "/tmp/ctp_flow_md")
os.environ.setdefault("CTP_FLOW_DIR_TD", "/tmp/ctp_flow_td")
os.makedirs(os.environ["CTP_FLOW_DIR_MD"], exist_ok=True)
os.makedirs(os.environ["CTP_FLOW_DIR_TD"], exist_ok=True)

lib = cdll.LoadLibrary("./libpyctp_bridge.so")

MD  = PYFUNCTYPE(None, c_char_p, c_double, c_double, c_double, c_longlong, c_longlong, c_longlong)
TRD = PYFUNCTYPE(None, c_char_p, c_char_p, c_char_p)
last_tick = {}

# 保持全局引用，防 GC
def on_md(i, l, b, a, ts_ex, ts_cpp, ts_redis):
    try:
        sym = i.decode()
        last_tick[sym] = (l, b, a)
        now_ms = int(time.time() * 1000)  # Python打印时刻
        print(f"tick {sym} last={l} bid1={b} ask1={a} "
              f"exch={ts_ex} cpp_recv={ts_cpp} redis_ok={ts_redis} py_now={now_ms} "
              f"d(ex->cpp)={ts_cpp - ts_ex if ts_ex else None} "
              f"d(cpp->redis)={(ts_redis - ts_cpp) if (ts_cpp and ts_redis) else None} "
              f"d(ex->py)={now_ms - ts_ex if ts_ex else None}")
    except Exception as e:
        print("tick error:", e)

def on_trd(ref, phase, text):
    try:
        # 错误信息多为 GBK，直接按 GBK 解码避免乱码
        print("trade",
              ref.decode('utf-8', 'ignore'),
              phase.decode('utf-8', 'ignore'),
              text.decode('gbk', 'ignore'))
    except Exception as e:
        print("trade error:", e)

def _hex(b: bytes) -> str:
    return " ".join(f"{x:02X}" for x in b)

md_cb  = MD(on_md)
trd_cb = TRD(on_trd)

# 注册（日志回调易崩，已在 C++ 层禁用 set_log_cb 的实际调用）
lib.ctp_set_md_cb(md_cb)
lib.ctp_set_trade_cb(trd_cb)


# 新增：设置 Redis 前缀（只用 SET/HSET）
try:
    lib.ctp_redis_set_prefixes.argtypes = [c_char_p, c_char_p]
    lib.ctp_redis_set_prefixes(b"teamPublic:md:last_json:", b"teamPublic:mdh:last:")
except AttributeError:
    pass

# Redis 连接（ACL）
lib.ctp_redis_init_acl.argtypes = [c_char_p, c_int, c_char_p, c_char_p, c_int, c_char_p]
lib.ctp_redis_init_acl.restype  = c_int
rc = lib.ctp_redis_init_acl(b"192.168.10.12", 6381, b"teamPublic_write", b"f2f71a01", 0, None)
print("redis init rc =", rc)

try:
    lib.ctp_redis_set_pipeline.argtypes = [c_int, c_int]
    lib.ctp_redis_set_pipeline.restype  = c_int
    # 启用 pipeline，窗口按“命令数”计数，建议 500~4000；越大吞吐越高但延迟上升
    lib.ctp_redis_set_pipeline(1, 2000)
except AttributeError:
    pass

# 配置
cfg = configparser.ConfigParser(); cfg.read(os.path.join(base,"config.ini"), encoding="utf-8")
md_front = cfg.get("config","FrontMdAddr").encode()
td_front = cfg.get("config","FrontAddr").encode()
broker   = cfg.get("config","BrokerID").encode()
user     = cfg.get("config","UserID").encode()
pwd      = cfg.get("config","Password").encode()
app_id   = cfg.get("config","AppID", fallback="").encode()
auth     = cfg.get("config","AuthCode", fallback="").encode()

# 行情
lib.ctp_md_start.argtypes = [c_char_p, c_char_p, c_char_p, c_char_p]
lib.ctp_md_start.restype  = c_int
lib.ctp_md_wait_ready.argtypes = [c_int]
lib.ctp_md_wait_ready.restype  = c_int
lib.ctp_md_subscribe.argtypes  = [c_char_p]
lib.ctp_md_subscribe.restype   = c_int

assert lib.ctp_md_start(md_front, broker, user, pwd) == 0
assert lib.ctp_md_wait_ready(15000) == 1
# 粘贴到 test_bridge.py 示例：
inst_csv = b"AP511,AP512,AP601,AP603,AP604,AP605,AP610,CF511,CF601,CF603,CF605,CF607,CF609,CJ512,CJ601,CJ603,CJ605,CJ607,CJ609,CY511,CY512,CY601,CY602,CY603,CY604,CY605,CY606,CY607,CY608,CY609,CY610,FG511,FG512,FG512C1000,FG512C1020,FG512C1040,FG512C1060,FG512C1080,FG512C1100,FG512C1120,FG512C1140,FG512C1160,FG512C1180,FG512C1200,FG512C1220,FG512C1240,FG512C1260,FG512C1280,FG512C1300,FG512C1320,FG512C1340,FG512C1360,FG512C1380,FG512C1400,FG512C1420,FG512C1440,FG512C1460,FG512C1480,FG512C1500,FG512C1520,FG512C1540,FG512C1560,FG512C940,FG512C950,FG512C960,FG512C970,FG512C980,FG512C990,FG512P1000,FG512P1020,FG512P1040,FG512P1060,FG512P1080,FG512P1100,FG512P1120,FG512P1140,FG512P1160,FG512P1180,FG512P1200,FG512P1220,FG512P1240,FG512P1260,FG512P1280,FG512P1300,FG512P1320,FG512P1340,FG512P1360,FG512P1380,FG512P1400,FG512P1420,FG512P1440,FG512P1460,FG512P1480,FG512P1500,FG512P1520,FG512P1540,FG512P1560,FG512P940,FG512P950,FG512P960,FG512P970,FG512P980,FG512P990,FG601,FG601C1000,FG601C1020,FG601C1040,FG601C1060,FG601C1080,FG601C1100,FG601C1120,FG601C1140,FG601C1160,FG601C1180,FG601C1200,FG601C1220,FG601C1240,FG601C1260,FG601C1280,FG601C1300,FG601C1320,FG601C1340,FG601C1360,FG601C1380,FG601C1400,FG601C1420,FG601C1440,FG601C1460,FG601C1480,FG601C1500,FG601C1520,FG601C1540,FG601C1560,FG601C1580,FG601C1600,FG601C1620,FG601C880,FG601C890,FG601C900,FG601C910,FG601C920,FG601C930,FG601C940,FG601C950,FG601C960,FG601C970,FG601C980,FG601C990,FG601P1000,FG601P1020,FG601P1040,FG601P1060,FG601P1080,FG601P1100,FG601P1120,FG601P1140,FG601P1160,FG601P1180,FG601P1200,FG601P1220,FG601P1240,FG601P1260,FG601P1280,FG601P1300,FG601P1320,FG601P1340,FG601P1360,FG601P1380,FG601P1400,FG601P1420,FG601P1440,FG601P1460,FG601P1480,FG601P1500,FG601P1520,FG601P1540,FG601P1560,FG601P1580,FG601P1600,FG601P1620,FG601P880,FG601P890,FG601P900,FG601P910,FG601P920,FG601P930,FG601P940,FG601P950,FG601P960,FG601P970,FG601P980,FG601P990,FG602,FG602C1000,FG602C1020,FG602C1040,FG602C1060,FG602C1080,FG602C1100,FG602C1120,FG602C1140,FG602C1160,FG602C1180,FG602C1200,FG602C1220,FG602C1240,FG602C1260,FG602C1280,FG602C1300,FG602C1320,FG602C1340,FG602C1360,FG602C1380,FG602C1400,FG602C1420,FG602C1440,FG602C1460,FG602P1000,FG602P1020,FG602P1040,FG602P1060,FG602P1080,FG602P1100,FG602P1120,FG602P1140,FG602P1160,FG602P1180,FG602P1200,FG602P1220,FG602P1240,FG602P1260,FG602P1280,FG602P1300,FG602P1320,FG602P1340,FG602P1360,FG602P1380,FG602P1400,FG602P1420,FG602P1440,FG602P1460,FG603,FG603C1000,FG603C1020,FG603C1040,FG603C1060,FG603C1080,FG603C1100,FG603C1120,FG603C1140,FG603C1160,FG603C1180,FG603C1200,FG603C1220,FG603C1240,FG603C1260,FG603C1280,FG603C1300,FG603C1320,FG603C1340,FG603C1360,FG603C1380,FG603C1400,FG603C1420,FG603C1440,FG603C1460,FG603C1480,FG603P1000,FG603P1020,FG603P1040,FG603P1060,FG603P1080,FG603P1100,FG603P1120,FG603P1140,FG603P1160,FG603P1180,FG603P1200,FG603P1220,FG603P1240,FG603P1260,FG603P1280,FG603P1300,FG603P1320,FG603P1340,FG603P1360,FG603P1380,FG603P1400,FG603P1420,FG603P1440,FG603P1460,FG603P1480,FG604,FG605,FG605C1000,FG605C1020,FG605C1040,FG605C1060,FG605C1080,FG605C1100,FG605C1120,FG605C1140,FG605C1160,FG605C1180,FG605C1200,FG605C1220,FG605C1240,FG605C1260,FG605C1280,FG605C1300,FG605C1320,FG605C1340,FG605C1360,FG605C1380,FG605C1400,FG605C1420,FG605C1440,FG605C1460,FG605C1480,FG605C1500,FG605C1520,FG605C1540,FG605C1560,FG605C1580,FG605C1600,FG605C1620,FG605C1640,FG605C1660,FG605P1000,FG605P1020,FG605P1040,FG605P1060,FG605P1080,FG605P1100,FG605P1120,FG605P1140,FG605P1160,FG605P1180,FG605P1200,FG605P1220,FG605P1240,FG605P1260,FG605P1280,FG605P1300,FG605P1320,FG605P1340,FG605P1360,FG605P1380,FG605P1400,FG605P1420,FG605P1440,FG605P1460,FG605P1480,FG605P1500,FG605P1520,FG605P1540,FG605P1560,FG605P1580,FG605P1600,FG605P1620,FG605P1640,FG605P1660,FG606,FG607,FG608,FG609,FG609C1140,FG609C1160,FG609C1180,FG609C1200,FG609C1220,FG609C1240,FG609C1260,FG609C1280,FG609C1300,FG609C1320,FG609C1340,FG609C1360,FG609C1380,FG609C1400,FG609C1420,FG609C1440,FG609C1460,FG609C1480,FG609C1500,FG609C1520,FG609C1540,FG609P1140,FG609P1160,FG609P1180,FG609P1200,FG609P1220,FG609P1240,FG609P1260,FG609P1280,FG609P1300,FG609P1320,FG609P1340,FG609P1360,FG609P1380,FG609P1400,FG609P1420,FG609P1440,FG609P1460,FG609P1480,FG609P1500,FG609P1520,FG609P1540,FG610,HO2511-C-2500,HO2511-C-2550,HO2511-C-2600,HO2511-C-2650,HO2511-C-2700,HO2511-C-2750,HO2511-C-2800,HO2511-C-2850,HO2511-C-2900,HO2511-C-2950,HO2511-C-3000,HO2511-C-3050,HO2511-C-3100,HO2511-C-3150,HO2511-C-3200,HO2511-C-3250,HO2511-C-3300,HO2511-C-3350,HO2511-C-3400,HO2511-P-2500,HO2511-P-2550,HO2511-P-2600,HO2511-P-2650,HO2511-P-2700,HO2511-P-2750,HO2511-P-2800,HO2511-P-2850,HO2511-P-2900,HO2511-P-2950,HO2511-P-3000,HO2511-P-3050,HO2511-P-3100,HO2511-P-3150,HO2511-P-3200,HO2511-P-3250,HO2511-P-3300,HO2511-P-3350,HO2511-P-3400,HO2512-C-2250,HO2512-C-2300,HO2512-C-2350,HO2512-C-2400,HO2512-C-2450,HO2512-C-2500,HO2512-C-2600,HO2512-C-2650,HO2512-C-2700,HO2512-C-2750,HO2512-C-2800,HO2512-C-2850,HO2512-C-2900,HO2512-C-2950,HO2512-C-3000,HO2512-C-3050,HO2512-C-3100,HO2512-C-3150,HO2512-C-3200,HO2512-C-3250,HO2512-C-3300,HO2512-C-3350,HO2512-C-3400,HO2512-P-2250,HO2512-P-2300,HO2512-P-2350,HO2512-P-2400,HO2512-P-2450,HO2512-P-2500,HO2512-P-2600,HO2512-P-2650,HO2512-P-2700,HO2512-P-2750,HO2512-P-2800,HO2512-P-2850,HO2512-P-2900,HO2512-P-2950,HO2512-P-3000,HO2512-P-3050,HO2512-P-3100,HO2512-P-3150,HO2512-P-3200,HO2512-P-3250,HO2512-P-3300,HO2512-P-3350,HO2512-P-3400,HO2601-C-2650,HO2601-C-2700,HO2601-C-2750,HO2601-C-2800,HO2601-C-2850,HO2601-C-2900,HO2601-C-2950,HO2601-C-3000,HO2601-C-3050,HO2601-C-3100,HO2601-C-3150,HO2601-C-3200,HO2601-C-3250,HO2601-C-3300,HO2601-C-3350,HO2601-C-3400,HO2601-P-2650,HO2601-P-2700,HO2601-P-2750,HO2601-P-2800,HO2601-P-2850,HO2601-P-2900,HO2601-P-2950,HO2601-P-3000,HO2601-P-3050,HO2601-P-3100,HO2601-P-3150,HO2601-P-3200,HO2601-P-3250,HO2601-P-3300,HO2601-P-3350,HO2601-P-3400,HO2603-C-2250,HO2603-C-2300,HO2603-C-2350,HO2603-C-2400,HO2603-C-2450,HO2603-C-2500,HO2603-C-2600,HO2603-C-2700,HO2603-C-2800,HO2603-C-2900,HO2603-C-3000,HO2603-C-3100,HO2603-C-3200,HO2603-C-3300,HO2603-C-3400,HO2603-P-2250,HO2603-P-2300,HO2603-P-2350,HO2603-P-2400,HO2603-P-2450,HO2603-P-2500,HO2603-P-2600,HO2603-P-2700,HO2603-P-2800,HO2603-P-2900,HO2603-P-3000,HO2603-P-3100,HO2603-P-3200,HO2603-P-3300,HO2603-P-3400,HO2606-C-2400,HO2606-C-2450,HO2606-C-2500,HO2606-C-2600,HO2606-C-2700,HO2606-C-2800,HO2606-C-2900,HO2606-C-3000,HO2606-C-3100,HO2606-C-3200,HO2606-C-3300,HO2606-C-3400,HO2606-P-2400,HO2606-P-2450,HO2606-P-2500,HO2606-P-2600,HO2606-P-2700,HO2606-P-2800,HO2606-P-2900,HO2606-P-3000,HO2606-P-3100,HO2606-P-3200,HO2606-P-3300,HO2606-P-3400,HO2609-C-2600,HO2609-C-2700,HO2609-C-2800,HO2609-C-2900,HO2609-C-3000,HO2609-C-3100,HO2609-C-3200,HO2609-C-3300,HO2609-C-3400,HO2609-P-2600,HO2609-P-2700,HO2609-P-2800,HO2609-P-2900,HO2609-P-3000,HO2609-P-3100,HO2609-P-3200,HO2609-P-3300,HO2609-P-3400,IC2511,IC2512,IC2603,IC2606,IF2511,IF2512,IF2603,IF2606,IH2511,IH2512,IH2603,IH2606,IM2511,IM2512,IM2603,IM2606,IO2511-C-3750,IO2511-C-3800,IO2511-C-3850,IO2511-C-3900,IO2511-C-3950,IO2511-C-4000,IO2511-C-4050,IO2511-C-4100,IO2511-C-4150,IO2511-C-4200,IO2511-C-4250,IO2511-C-4300,IO2511-C-4350,IO2511-C-4400,IO2511-C-4450,IO2511-C-4500,IO2511-C-4550,IO2511-C-4600,IO2511-C-4650,IO2511-C-4700,IO2511-C-4750,IO2511-C-4800,IO2511-C-4850,IO2511-C-4900,IO2511-C-4950,IO2511-C-5000,IO2511-C-5100,IO2511-C-5200,IO2511-C-5300,IO2511-P-3750,IO2511-P-3800,IO2511-P-3850,IO2511-P-3900,IO2511-P-3950,IO2511-P-4000,IO2511-P-4050,IO2511-P-4100,IO2511-P-4150,IO2511-P-4200,IO2511-P-4250,IO2511-P-4300,IO2511-P-4350,IO2511-P-4400,IO2511-P-4450,IO2511-P-4500,IO2511-P-4550,IO2511-P-4600,IO2511-P-4650,IO2511-P-4700,IO2511-P-4750,IO2511-P-4800,IO2511-P-4850,IO2511-P-4900,IO2511-P-4950,IO2511-P-5000,IO2511-P-5100,IO2511-P-5200,IO2511-P-5300,IO2512-C-3200,IO2512-C-3300,IO2512-C-3400,IO2512-C-3500,IO2512-C-3600,IO2512-C-3700,IO2512-C-3800,IO2512-C-3900,IO2512-C-4000,IO2512-C-4050,IO2512-C-4100,IO2512-C-4150,IO2512-C-4200,IO2512-C-4250,IO2512-C-4300,IO2512-C-4350,IO2512-C-4400,IO2512-C-4450,IO2512-C-4500,IO2512-C-4550,IO2512-C-4600,IO2512-C-4650,IO2512-C-4700,IO2512-C-4750,IO2512-C-4800,IO2512-C-4850,IO2512-C-4900,IO2512-C-4950,IO2512-C-5000,IO2512-C-5100,IO2512-C-5200,IO2512-C-5300,IO2512-P-3200,IO2512-P-3300,IO2512-P-3400,IO2512-P-3500,IO2512-P-3600,IO2512-P-3700,IO2512-P-3800,IO2512-P-3900,IO2512-P-4000,IO2512-P-4050,IO2512-P-4100,IO2512-P-4150,IO2512-P-4200,IO2512-P-4250,IO2512-P-4300,IO2512-P-4350,IO2512-P-4400,IO2512-P-4450,IO2512-P-4500,IO2512-P-4550,IO2512-P-4600,IO2512-P-4650,IO2512-P-4700,IO2512-P-4750,IO2512-P-4800,IO2512-P-4850,IO2512-P-4900,IO2512-P-4950,IO2512-P-5000,IO2512-P-5100,IO2512-P-5200,IO2512-P-5300,IO2601-C-4050,IO2601-C-4100,IO2601-C-4150,IO2601-C-4200,IO2601-C-4250,IO2601-C-4300,IO2601-C-4350,IO2601-C-4400,IO2601-C-4450,IO2601-C-4500,IO2601-C-4550,IO2601-C-4600,IO2601-C-4650,IO2601-C-4700,IO2601-C-4750,IO2601-C-4800,IO2601-C-4850,IO2601-C-4900,IO2601-C-4950,IO2601-C-5000,IO2601-C-5100,IO2601-C-5200,IO2601-C-5300,IO2601-P-4050,IO2601-P-4100,IO2601-P-4150,IO2601-P-4200,IO2601-P-4250,IO2601-P-4300,IO2601-P-4350,IO2601-P-4400,IO2601-P-4450,IO2601-P-4500,IO2601-P-4550,IO2601-P-4600,IO2601-P-4650,IO2601-P-4700,IO2601-P-4750,IO2601-P-4800,IO2601-P-4850,IO2601-P-4900,IO2601-P-4950,IO2601-P-5000,IO2601-P-5100,IO2601-P-5200,IO2601-P-5300,IO2603-C-3200,IO2603-C-3300,IO2603-C-3400,IO2603-C-3500,IO2603-C-3600,IO2603-C-3700,IO2603-C-3800,IO2603-C-3900,IO2603-C-4000,IO2603-C-4100,IO2603-C-4200,IO2603-C-4300,IO2603-C-4400,IO2603-C-4500,IO2603-C-4600,IO2603-C-4700,IO2603-C-4800,IO2603-C-4900,IO2603-C-5000,IO2603-C-5200,IO2603-C-5400,IO2603-P-3200,IO2603-P-3300,IO2603-P-3400,IO2603-P-3500,IO2603-P-3600,IO2603-P-3700,IO2603-P-3800,IO2603-P-3900,IO2603-P-4000,IO2603-P-4100,IO2603-P-4200,IO2603-P-4300,IO2603-P-4400,IO2603-P-4500,IO2603-P-4600,IO2603-P-4700,IO2603-P-4800,IO2603-P-4900,IO2603-P-5000,IO2603-P-5200,IO2603-P-5400,IO2606-C-3400,IO2606-C-3500,IO2606-C-3600,IO2606-C-3700,IO2606-C-3800,IO2606-C-3900,IO2606-C-4000,IO2606-C-4100,IO2606-C-4200,IO2606-C-4300,IO2606-C-4400,IO2606-C-4500,IO2606-C-4600,IO2606-C-4700,IO2606-C-4800,IO2606-C-4900,IO2606-C-5000,IO2606-C-5200,IO2606-C-5400,IO2606-P-3400,IO2606-P-3500,IO2606-P-3600,IO2606-P-3700,IO2606-P-3800,IO2606-P-3900,IO2606-P-4000,IO2606-P-4100,IO2606-P-4200,IO2606-P-4300,IO2606-P-4400,IO2606-P-4500,IO2606-P-4600,IO2606-P-4700,IO2606-P-4800,IO2606-P-4900,IO2606-P-5000,IO2606-P-5200,IO2606-P-5400,IO2609-C-4000,IO2609-C-4100,IO2609-C-4200,IO2609-C-4300,IO2609-C-4400,IO2609-C-4500,IO2609-C-4600,IO2609-C-4700,IO2609-C-4800,IO2609-C-4900,IO2609-C-5000,IO2609-C-5200,IO2609-C-5400,IO2609-P-4000,IO2609-P-4100,IO2609-P-4200,IO2609-P-4300,IO2609-P-4400,IO2609-P-4500,IO2609-P-4600,IO2609-P-4700,IO2609-P-4800,IO2609-P-4900,IO2609-P-5000,IO2609-P-5200,IO2609-P-5400,JR511,JR601,JR603,JR605,JR607,JR609,LR511,LR601,MA511,MA512,MA512C2000,MA512C2025,MA512C2050,MA512C2075,MA512C2100,MA512C2125,MA512C2150,MA512C2175,MA512C2200,MA512C2225,MA512C2250,MA512C2275,MA512C2300,MA512C2325,MA512C2350,MA512C2375,MA512C2400,MA512C2425,MA512C2450,MA512C2475,MA512C2500,MA512C2550,MA512C2600,MA512C2650,MA512C2700,MA512C2750,MA512C2800,MA512C2850,MA512P2000,MA512P2025,MA512P2050,MA512P2075,MA512P2100,MA512P2125,MA512P2150,MA512P2175,MA512P2200,MA512P2225,MA512P2250,MA512P2275,MA512P2300,MA512P2325,MA512P2350,MA512P2375,MA512P2400,MA512P2425,MA512P2450,MA512P2475,MA512P2500,MA512P2550,MA512P2600,MA512P2650,MA512P2700,MA512P2750,MA512P2800,MA512P2850,MA601,MA601C2000,MA601C2025,MA601C2050,MA601C2075,MA601C2100,MA601C2125,MA601C2150,MA601C2175,MA601C2200,MA601C2225,MA601C2250,MA601C2275,MA601C2300,MA601C2325,MA601C2350,MA601C2375,MA601C2400,MA601C2425,MA601C2450,MA601C2475,MA601C2500,MA601C2550,MA601C2600,MA601C2650,MA601C2700,MA601C2750,MA601C2800,MA601C2850,MA601P2000,MA601P2025,MA601P2050,MA601P2075,MA601P2100,MA601P2125,MA601P2150,MA601P2175,MA601P2200,MA601P2225,MA601P2250,MA601P2275,MA601P2300,MA601P2325,MA601P2350,MA601P2375,MA601P2400,MA601P2425,MA601P2450,MA601P2475,MA601P2500,MA601P2550,MA601P2600,MA601P2650,MA601P2700,MA601P2750,MA601P2800,MA601P2850,MA602,MA602C2050,MA602C2075,MA602C2100,MA602C2125,MA602C2150,MA602C2175,MA602C2200,MA602C2225,MA602C2250,MA602C2275,MA602C2300,MA602C2325,MA602C2350,MA602C2375,MA602C2400,MA602C2425,MA602C2450,MA602C2475,MA602C2500,MA602C2550,MA602C2600,MA602C2650,MA602C2700,MA602P2050,MA602P2075,MA602P2100,MA602P2125,MA602P2150,MA602P2175,MA602P2200,MA602P2225,MA602P2250,MA602P2275,MA602P2300,MA602P2325,MA602P2350,MA602P2375,MA602P2400,MA602P2425,MA602P2450,MA602P2475,MA602P2500,MA602P2550,MA602P2600,MA602P2650,MA602P2700,MA603,MA603C2075,MA603C2100,MA603C2125,MA603C2150,MA603C2175,MA603C2200,MA603C2225,MA603C2250,MA603C2275,MA603C2300,MA603C2325,MA603C2350,MA603C2375,MA603C2400,MA603C2425,MA603C2450,MA603C2475,MA603C2500,MA603C2550,MA603C2600,MA603P2075,MA603P2100,MA603P2125,MA603P2150,MA603P2175,MA603P2200,MA603P2225,MA603P2250,MA603P2275,MA603P2300,MA603P2325,MA603P2350,MA603P2375,MA603P2400,MA603P2425,MA603P2450,MA603P2475,MA603P2500,MA603P2550,MA603P2600,MA604,MA605,MA605C2075,MA605C2100,MA605C2125,MA605C2150,MA605C2175,MA605C2200,MA605C2225,MA605C2250,MA605C2275,MA605C2300,MA605C2325,MA605C2350,MA605C2375,MA605C2400,MA605C2425,MA605C2450,MA605C2475,MA605C2500,MA605C2550,MA605C2600,MA605C2650,MA605C2700,MA605C2750,MA605P2075,MA605P2100,MA605P2125,MA605P2150,MA605P2175,MA605P2200,MA605P2225,MA605P2250,MA605P2275,MA605P2300,MA605P2325,MA605P2350,MA605P2375,MA605P2400,MA605P2425,MA605P2450,MA605P2475,MA605P2500,MA605P2550,MA605P2600,MA605P2650,MA605P2700,MA605P2750,MA606,MA607,MA608,MA609,MA610,MO2511-C-6300,MO2511-C-6400,MO2511-C-6500,MO2511-C-6600,MO2511-C-6700,MO2511-C-6800,MO2511-C-6900,MO2511-C-7000,MO2511-C-7100,MO2511-C-7200,MO2511-C-7300,MO2511-C-7400,MO2511-C-7500,MO2511-C-7600,MO2511-C-7700,MO2511-C-7800,MO2511-C-7900,MO2511-C-8000,MO2511-C-8100,MO2511-C-8200,MO2511-C-8300,MO2511-C-8400,MO2511-C-8500,MO2511-P-6300,MO2511-P-6400,MO2511-P-6500,MO2511-P-6600,MO2511-P-6700,MO2511-P-6800,MO2511-P-6900,MO2511-P-7000,MO2511-P-7100,MO2511-P-7200,MO2511-P-7300,MO2511-P-7400,MO2511-P-7500,MO2511-P-7600,MO2511-P-7700,MO2511-P-7800,MO2511-P-7900,MO2511-P-8000,MO2511-P-8100,MO2511-P-8200,MO2511-P-8300,MO2511-P-8400,MO2511-P-8500,MO2512-C-4900,MO2512-C-5000,MO2512-C-5200,MO2512-C-5400,MO2512-C-5600,MO2512-C-5800,MO2512-C-6000,MO2512-C-6200,MO2512-C-6400,MO2512-C-6500,MO2512-C-6600,MO2512-C-6700,MO2512-C-6800,MO2512-C-6900,MO2512-C-7000,MO2512-C-7100,MO2512-C-7200,MO2512-C-7300,MO2512-C-7400,MO2512-C-7500,MO2512-C-7600,MO2512-C-7700,MO2512-C-7800,MO2512-C-7900,MO2512-C-8000,MO2512-C-8100,MO2512-C-8200,MO2512-C-8300,MO2512-C-8400,MO2512-C-8500,MO2512-P-4900,MO2512-P-5000,MO2512-P-5200,MO2512-P-5400,MO2512-P-5600,MO2512-P-5800,MO2512-P-6000,MO2512-P-6200,MO2512-P-6400,MO2512-P-6500,MO2512-P-6600,MO2512-P-6700,MO2512-P-6800,MO2512-P-6900,MO2512-P-7000,MO2512-P-7100,MO2512-P-7200,MO2512-P-7300,MO2512-P-7400,MO2512-P-7500,MO2512-P-7600,MO2512-P-7700,MO2512-P-7800,MO2512-P-7900,MO2512-P-8000,MO2512-P-8100,MO2512-P-8200,MO2512-P-8300,MO2512-P-8400,MO2512-P-8500,MO2601-C-6400,MO2601-C-6500,MO2601-C-6600,MO2601-C-6700,MO2601-C-6800,MO2601-C-6900,MO2601-C-7000,MO2601-C-7100,MO2601-C-7200,MO2601-C-7300,MO2601-C-7400,MO2601-C-7500,MO2601-C-7600,MO2601-C-7700,MO2601-C-7800,MO2601-C-7900,MO2601-C-8000,MO2601-C-8100,MO2601-C-8200,MO2601-C-8300,MO2601-C-8400,MO2601-P-6400,MO2601-P-6500,MO2601-P-6600,MO2601-P-6700,MO2601-P-6800,MO2601-P-6900,MO2601-P-7000,MO2601-P-7100,MO2601-P-7200,MO2601-P-7300,MO2601-P-7400,MO2601-P-7500,MO2601-P-7600,MO2601-P-7700,MO2601-P-7800,MO2601-P-7900,MO2601-P-8000,MO2601-P-8100,MO2601-P-8200,MO2601-P-8300,MO2601-P-8400,MO2603-C-4900,MO2603-C-5000,MO2603-C-5200,MO2603-C-5400,MO2603-C-5600,MO2603-C-5800,MO2603-C-6000,MO2603-C-6200,MO2603-C-6400,MO2603-C-6600,MO2603-C-6800,MO2603-C-7000,MO2603-C-7200,MO2603-C-7400,MO2603-C-7600,MO2603-C-7800,MO2603-C-8000,MO2603-C-8200,MO2603-C-8400,MO2603-C-8600,MO2603-P-4900,MO2603-P-5000,MO2603-P-5200,MO2603-P-5400,MO2603-P-5600,MO2603-P-5800,MO2603-P-6000,MO2603-P-6200,MO2603-P-6400,MO2603-P-6600,MO2603-P-6800,MO2603-P-7000,MO2603-P-7200,MO2603-P-7400,MO2603-P-7600,MO2603-P-7800,MO2603-P-8000,MO2603-P-8200,MO2603-P-8400,MO2603-P-8600,MO2606-C-5200,MO2606-C-5400,MO2606-C-5600,MO2606-C-5800,MO2606-C-6000,MO2606-C-6200,MO2606-C-6400,MO2606-C-6600,MO2606-C-6800,MO2606-C-7000,MO2606-C-7200,MO2606-C-7400,MO2606-C-7600,MO2606-C-7800,MO2606-C-8000,MO2606-C-8200,MO2606-C-8400,MO2606-C-8600,MO2606-P-5200,MO2606-P-5400,MO2606-P-5600,MO2606-P-5800,MO2606-P-6000,MO2606-P-6200,MO2606-P-6400,MO2606-P-6600,MO2606-P-6800,MO2606-P-7000,MO2606-P-7200,MO2606-P-7400,MO2606-P-7600,MO2606-P-7800,MO2606-P-8000,MO2606-P-8200,MO2606-P-8400,MO2606-P-8600,MO2609-C-6400,MO2609-C-6600,MO2609-C-6800,MO2609-C-7000,MO2609-C-7200,MO2609-C-7400,MO2609-C-7600,MO2609-C-7800,MO2609-C-8000,MO2609-C-8200,MO2609-C-8400,MO2609-C-8600,MO2609-P-6400,MO2609-P-6600,MO2609-P-6800,MO2609-P-7000,MO2609-P-7200,MO2609-P-7400,MO2609-P-7600,MO2609-P-7800,MO2609-P-8000,MO2609-P-8200,MO2609-P-8400,MO2609-P-8600,OI511,OI601,OI603,OI605,OI607,OI609,PF511,PF512,PF601,PF602,PF603,PF604,PF605,PF606,PF607,PF608,PF609,PF610,PK511,PK512,PK601,PK603,PK604,PK605,PK610,PM511,PM601,PM603,PM605,PM607,PM609,PR511,PR512,PR601,PR602,PR603,PR604,PR605,PR606,PR607,PR608,PR609,PR610,PX511,PX512,PX601,PX602,PX603,PX604,PX605,PX606,PX607,PX608,PX609,PX610,RI511,RI601,RI603,RI605,RI607,RI609,RM511,RM601,RM601C1975,RM601C2000,RM601C2025,RM601C2050,RM601C2075,RM601C2100,RM601C2125,RM601C2150,RM601C2175,RM601C2200,RM601C2225,RM601C2250,RM601C2275,RM601C2300,RM601C2325,RM601C2350,RM601C2375,RM601C2400,RM601C2425,RM601C2450,RM601C2475,RM601C2500,RM601C2550,RM601C2600,RM601C2650,RM601C2700,RM601C2750,RM601C2800,RM601C2850,RM601C2900,RM601C2950,RM601C3000,RM601C3050,RM601C3100,RM601C3150,RM601P1975,RM601P2000,RM601P2025"
# 使用: lib.ctp_md_subscribe(inst_csv)
lib.ctp_md_subscribe(inst_csv)

# 交易（复用 traderSpi.cpp + 钩子）
lib.ctp_td_start.argtypes = [c_char_p, c_char_p, c_char_p, c_char_p, c_char_p, c_char_p]
lib.ctp_td_start.restype  = c_int
lib.ctp_td_wait_ready.argtypes = [c_int]
lib.ctp_td_wait_ready.restype  = c_int
lib.ctp_td_place.argtypes = [c_char_p, c_char_p, c_char, c_char, c_int, c_char, c_double]
lib.ctp_td_place.restype  = c_int

# 前置连通性快速检查
m = re.match(rb"tcp://([^:]+):(\d+)", td_front)
if m:
    host, port = m.group(1).decode(), int(m.group(2))
    with socket.socket() as s:
        s.settimeout(3.0); s.connect((host, port))
        print("TD front reachable:", host, port)

print("BrokerID:", broker, _hex(broker))
print("UserID  :", user,   _hex(user))
print("Password:", pwd,    _hex(pwd))
print("AppID   :", app_id, _hex(app_id))
print("AuthCode:", auth,   _hex(auth))

assert lib.ctp_td_start(td_front, broker, user, pwd, app_id if app_id else None, auth if auth else None) == 0
td_ready = lib.ctp_td_wait_ready(60000)
if td_ready != 1:
    raise RuntimeError(f"td not ready, state={td_ready}")



def on_md(i, l, b, a, ts_ex, ts_cpp, ts_redis):
    try:
        sym = i.decode()
        last_tick[sym] = (l, b, a)
        now_ms = int(time.time() * 1000)
        # print(f"tick {sym} last={l} bid1={b} ask1={a} "
        #       f"exch={ts_ex} cpp_recv={ts_cpp} redis_ok={ts_redis} py_now={now_ms} "
        #       f"d(ex->cpp)={ts_cpp - ts_ex if ts_ex else None} "
        #       f"d(cpp->redis)={(ts_redis - ts_cpp) if (ts_cpp and ts_redis) else None} "
        #       f"d(ex->py)={now_ms - ts_ex if ts_ex else None}")
    except Exception as e:
        print("tick error:", e)

def on_trd(ref, phase, text):
    try:
        print("trade",
              ref.decode('utf-8', 'ignore'),
              phase.decode('utf-8', 'ignore'),
              text.decode('gbk', 'ignore'))  # CTP 错误多为 GBK
    except Exception as e:
        print("trade error:", e)
        
# inst = "IM2512"
# side = b'B'  # 买 B / 卖 S
# offset = b'O'  # 开 O / 平 C（仅示例）
# pricetype = b'L'  # 限价单

# # 示例下单：市价买开 1 手
# for _ in range(50):
#     lba = last_tick.get(inst)
#     if lba and ((side == b'B' and lba[2] > 0) or (side == b'S' and lba[1] > 0)):
#         break
#     time.sleep(0.1)
l, b, a = last_tick.get(inst_csv, (0.0, 0.0, 0.0))
print(l, b, a)
# price = a if side == b'B' else b
# if price <= 0:
#     raise RuntimeError("无有效盘口价，暂不下单")
# rc = lib.ctp_td_place(b"strat_alpha", inst.encode(), side, offset, 1, pricetype, float(price))
# print("place rc =", rc)

# 常驻
for _ in range(600):
    time.sleep(1)